\documentclass[a4paper]{article}
\usepackage{pgfplotstable}
\usepackage{longtable}
\usepackage{varwidth}
\usepackage{array}
\usepackage{lscape}
\usepackage[top=4.5 cm,bottom=2.54cm, lmargin=2cm, rmargin=1.74cm, headheight=3.25cm]{geometry}
\usepackage{helvet}
\usepackage{tabto}
\usepackage{collcell}
\usepackage{seqsplit}
\usepackage{fancyhdr}
\usepackage{lastpage}
\usepackage{xcolor}
\usepackage{sectsty}
\usepackage{mdframed}
\usepackage{draftwatermark}
\usepackage{textpos}
\usepackage{placeins}
\usepackage{listings}
\usepackage{tikz}
\usepackage[hidelinks]{hyperref}

\SetWatermarkText{Draft}

\definecolor{maroon}{RGB}{102,0,33}
\sectionfont{\color{maroon}}  % sets colour of section headings

\renewcommand{\familydefault}{\sfdefault}

% Set title etc
\title {Copernicus Climate Change Service - 311a Lot 2 \\ Defining a Common Data Model}
\author {David I. Berry \\ National Oceanography Centre, UK}
\date{\today}

% empty header style for tables later on
\pgfplotstableset{
empty header/.style={
           typeset cell/.append code={%
               \ifnum\pgfplotstablerow=-1 %
                   \pgfkeyssetvalue{/pgfplots/table/@cell content}{}%
               \fi
           }
       }
   }

% new column for tables to split long strings
\newcolumntype{n}[1]{  > {\collectcell\seqsplit} V{#1} < {\endcollectcell}    }

% no indent of new paragraphs
\setlength{\parindent}{0pt}

% framed text boxes
\newcounter{FramedDepth}
\setcounter{FramedDepth}{-1}
\mdfdefinestyle{Framed}{linecolor=black,linewidth=1pt,leftmargin=10pt,rightmargin=10pt,
                        innerleftmargin=10pt,innerrightmargin=10pt}
\newenvironment{Framed}{%
  \addtocounter{FramedDepth}{1}
  \ifcase\theFramedDepth\def\FrameColour{white!50}%
    \or\def\FrameColour{white!50}%
    \or\def\FrameColour{white!50}%
    \or\def\FrameColour{white!50}%
    \fi%
  \begin{mdframed}[style=Framed,backgroundcolor=\FrameColour]%
}{\end{mdframed}\addtocounter{FramedDepth}{-1}}


% 1.25 18.4, 1.7
% 0.65
% Copernicus logo on page 3 onwards needs to go at (18.4cm, 1.7cm from top left of page) size (0.9cm by 0.86 cm)

% headers and footers
\headheight 3.5 cm          
\headsep  0.5 cm

\lhead{\textcolor{maroon}{Copernicus Climate Change Service}\vskip 0.5 cm}
\rhead{\includegraphics{/Users/dyb/GitHub/common_data_model/png/c3s_logo_small.png} \vskip 0.3 cm}

\lfoot{C3S\_311a\_Lot2\_NUIM\_2017 \{ref\} }
\cfoot{}
\rfoot{Page \textbf{\thepage}  of \textbf{\pageref{LastPage}} }

\pagestyle{fancy}

\begin{document}\thispagestyle{empty}


% Cover sheet

% top banner
\begin{tikzpicture}[remember picture,overlay]
\draw ([yshift=-15.7mm]current page.north) node[inner sep=0] (a) {\includegraphics[width=\paperwidth]{/Users/dyb/GitHub/common_data_model/png/c3s_banner_top.png}};
\draw ([yshift=-25.7mm]current page.north) node[inner sep=0] (a) {\includegraphics[width=62.8mm]{/Users/dyb/GitHub/common_data_model/png/copernicus_logo_large.png}};
\node[shift={(0 mm, -10mm)}]  at (current page.north)   {
\tiny\color{white} ECMWF COPERNICUS REPORT \\
};
\end{tikzpicture}

% top maroon bar
\begin{tikzpicture}[remember picture,overlay]
\draw ([yshift=-53.3 mm]current page.north) node[inner sep=0] (a) {\includegraphics[width=\paperwidth]{/Users/dyb/GitHub/common_data_model/png/header_bar.png}};
\draw ([xshift=95mm, yshift=-53.0 mm]current page.north) node[inner sep=0] (a) {\includegraphics[width=11.8mm]{/Users/dyb/GitHub/common_data_model/png/logo_thermometer.png}};
\draw ([xshift=89mm, yshift=-55.0 mm]current page.north) node[inner sep=0] (a) {\includegraphics[width=12.0mm]{/Users/dyb/GitHub/common_data_model/png/logo_earth.png}};
\node at (1.5,-0.15)   {
    \color{white} Copernicus Climate Change Service
};
\node at (2.5,-0.65)   {
    \color{white} Copernicus Climate Change Service
};
\end{tikzpicture}


\vskip 4cm
\begin{center} 
\Large\textbf{Copernicus Climate Change Service - 311a Lot 2 \\ Defining a Common Data Model}
\vskip 1cm
\Large C3S\_311a\_Lot2\_NUIM - Access to Observations from Global Climate Data Archives
\end{center}

%footer bar
\begin{tikzpicture}[remember picture,overlay]
\draw ([yshift=15. mm]current page.south) node[inner sep=0] (a) {\includegraphics[width=\paperwidth]{/Users/dyb/GitHub/common_data_model/png/footer_bar.png}};
\draw ([yshift=10.5 mm]current page.south) node[inner sep=0] (a) {\includegraphics{/Users/dyb/GitHub/common_data_model/png/copernicus_logo.png}};
\draw ([xshift=-30 mm, yshift=10.5 mm]current page.south east) node[inner sep=0] (a) {\includegraphics{/Users/dyb/GitHub/common_data_model/png/ECMWF_logo.png}};
\draw ([xshift=30 mm, yshift=10.5 mm]current page.south west) node[inner sep=0] (a) {\includegraphics{/Users/dyb/GitHub/common_data_model/png/ec_logo_small.png}};
\end{tikzpicture}
\newpage

\vspace*{\fill}
\begin{Framed}
This document has been produced in the context of the Copernicus Climate Change Service (C3S).\\
The activities leading to these results have been contracted by the European Centre for Medium-Range Weather Forecasts, operator of C3S on behalf of the European Union (Delegation Agreement signed on 11/11/2014). All information in this document is provided "as is" and no guarantee or warranty is given that the information is fit for any particular purpose.\\
The user thereof uses the information at its sole risk and liability. For the avoidance of all doubts, the European Commission
and the European Centre for Medium-Range Weather Forecasts has no liability in respect of this document, which is merely representing the authors view.
\end{Framed}

% title page
\newpage

\maketitle

\vskip 0.25in
\section*{Summary}
\hrule
\vskip 0.25in
This document describes background information on the definition of a common data model for the representation of in situ observations as part of the C3S 311a activity.\\ \\
A draft data model is proposed.\\ \\
\textbf{Call participants are requested to}:\\
\begin{itemize}
\item Review the proposed data model, specifically tables 3 - 7.
\item Review the configuration field tables and suggest modifications, additions and deletions.
\item Review the configuration code tables and suggest modifications, additions and deletions.
\item Review the code tables and propose / identify where an existing table (e.g. BUFR code table) and be used in replacement.
\end{itemize}
\vskip 0.25in
Tab separated versions of the code tables can be found at:\\ \\
\tabto{2cm} \url{https://github.com/glamod/common_data_model/tree/master/tables}
\vskip 0.25in
\hrule

\newpage
\tableofcontents
\newpage
\listoftables
\newpage


\section {Introduction}

\subsection {Purpose of this document}
This document defines the initial version of the Common Data Model (CDM)\footnote{As noted in the ITT: A common data model is different from a file format, which defines how information is encoded in a file. The purpose of a data model is to provide a well-defined data structure that can be used to represent data records from a variety of sources, in such a way that the information contained in those records can be unambiguously accessed using a common set of tools. Development of a common data model for observations involves specification of data attributes and their symbolic names, including, for example, identifiers for different instruments, observed parameters, geolocation and timing, etc. A governance structure is required to manage such specifications, ensure consistency with standards where they exist, and to ensure a controlled evolution of the data model.} developed within the Copernicus Climate Change Service (C3S) Access to Global Land and Marine Observations Database (C3S 311a Lot 2) service. This has been developed in consultation across the C3S 311a (Collection and Processing of In Situ Observations) Lots and ECMWF.

\subsection {Scope}
The defined common data model is intended for use with in situ land and marine observations. Instantaneous (or point) observations and temporal statistics (e.g. daily and monthly min / max temperatures, accumulation of precipitation etc.)  are supported through the use of a significance qualifier. Similarly, profile data is supported through reporting the z-coordinate alongside the observed value.\\

Whilst initially intended for use with observations of Essential Climate Variables (ECVs; e.g. GCOS, 2010) the data model is not restricted to the ECVs. Following the ECMWF Observations DataBase (ODB) type data model, the measurand (or observed parameter) is parameterized, with both the variable being reported and it's value specified in the data model.\\

Comprehensive metadata is supported through the use of configuration tables, recording information on:
\begin{itemize}
\item Source level metadata: e.g. original source of data, source data centre, citation information etc.
\item Station level metadata: e.g. location, operating institute, parameters reported etc.
\item Profile level metadata: Additional information for profile data, e.g. unwinder type, type of balloon or XBT etc.
\item Sensor level metadata: e.g. calibration history and status, sensor type / serial number etc.
\end{itemize}
Comprehensive quality control and uncertainty information can be record through the use of linked entity-attribute-value tables.

\subsection {Structure of this document}

Section 2 of this document provides backgound information on the data model and existing relevant data models and standards. Section 3 forms the core section of this document and defines the primary observations table and associated configuration, quality control and uncertainty budget tables. Recognising that the data model will change and evolve as the requirements of the users and the C3S Climate Data Store develop, Section 4 proposes a goverance model for the CDM and outlines future developments.

\section {Background and existing standards}
\subsection {Observational sources and requirements of the data model}

Across the C3S 311a (Collection and Processing of In Situ Observations) service access to observations from the surface terrestrial and marine environments and upper air data will be provided in a Common Data Model. The observations included in the service range from point observations made from moving platforms to daily and monthly statistics at fixed locations.  The parameters reported include, inter alia: air temperature; humidity; wind speed; pressure; cloud cover information; present weather. The statistics include, inter alia: daily min, max and mean air temperature; accumulated precipitation over 3 or 24 hours; mean wind speed over the preceding 10 minutes. The full range of parameters and statistics to be reported will evolve as the service is developed. As new parameters are recovered from newly digitised sources and the reprocessed climate archives the list of parameters will need to expand.\\

Both surface level (terrestrial and marine) and upper air data will be included in the service.  The surface level data includes observations made at standard and non-standard heights. The upper air data will include multiple observations, starting at the surface and at increasing height through the atmosphere, often as a function of pressure or geopotential height. As a result the data model needs to include the flexibility to record the height and the units used for reporting the height of observation with every observation. Similarly, some reporting stations, and hence observations, will move in the horizontal plan, and the horizontal coordinates need to be reported with each observation. To avoid ambiguity, the CRS should be provided with each location reported.\\

The period covered by the service ranges from $\sim$1850 to present day. Over this period there have been many changes to the instruments and practices used to record the various parameters. The choice of instruments and practices will influence the quality of the observations and a change in instrumentation, or location, may introduce inhomogeneities into the record.  To mitigate this risk, comprehensive observational metadata, where it exists, is required. Similarly, information on adjustments and conversions applied to the data need to be recorded. The full range of observational practices and instruments used is not currently known and developed data model will need to be expandable to accommodate new metadata as required.\\

The observations to be included will be sourced from a variety of existing datasets, such as the International Comprehensive Ocean and Atmosphere Data Set (ICOADS; e.g. Freeman et al., 2017), and newly digitised sources. In defining the data model the provenance and lineage of the data sources need to be preserved. Similarly, usage rights and citation information for those data sources need to be preserved and provided to the users alongside the observational data.\\

In order to meet the above requirements a data model based on the ECMWF Observations DataBase (ODB) model has been developed, with the use of linked tables providing information on the observational and provenance metadata. The ODB type model allows for expansion to new parameters through the use of a parameterized observation list (see next section). The linked tables will define a core set of parameters under 4 different categories (station, source, profile and sensor), flexibility will be provided through the specification of optional elements and associated decode tables.\\

\subsection{ECMWF Observations DataBase (ODB)}

The data model defined and used in the ECMWF Observations DataBase (ODB) software allows the representation of environmental data from many sources, including in situ observations, satellite data and model output. This flexibility is achieved through storing each observation, or estimate, of a single parameter as a separate record together with header information providing information on the location and source of the observation. Where multiple observations are made in a single report the report spans multiple records, with the header information repeated. A simplified example is given in Table 1. Additional tables give further information on the coded values.\\

\input{odb_example}

\subsection {BUFR and WIGOS Metadata Standard}
There has been a large body of work and significant effort previously invested in defining data models and parameterising the data and metadata for encoding the data into those data models.  Within the scope of the CDM and the C3S 311a service, the WMO Binary Universal Form for the Representation of meteorological data (BUFR) (WMO, 2015a) and the WMO Integrated Observing System Metadata Standard (WMDS) (WMO, 2015b) are key background material. \\

The BUFR format is a flexible and efficient table driven format for reporting weather observations on the WMO Global Telecommunications System (GTS) in binary. The tables defined as part of the BUFR format include many of the parameters that will be included in the CDM. For example, Common code table C6 (WMO 2015a) includes all the measurement units reportable in BUFR (and other WMO codes). Similarly, code tables are defined for reporting instrument types and methods, station types etc. Where possible, these code tables have been referenced and used in preference to defining new code tables.  Tables from Version 27 of Master Table 0 have been used in this document.\\

In recognition of the increasing importance of observational metadata the WMDS is currently under development and undergoing a phased implementation (WMO, 2015b). The WMDS forms an extension of the ISO19115 metadata standard, with additional mandatory elements describing both the station level and discovery metadata as well as specific information on the instrumentation used and processing steps. As part of the process simplified versions of BUFR and other tables have been included in the standard. As with BUFR these tables have been referenced, where appropriate, in preference to defining new code tables.\\

\section {Common Data Model}
\FloatBarrier
Whilst the ODB data model has great flexibility the requirements of the implementation at ECMWF and that required by the C3S 311a service are different. For example, the existing columns defined within ECMWFs ODB implementation\footnote{http://apps.ecmwf.int/odbgov/column/}  contain many parameters that are of little relevance to the in situ observations but are relevant to the assimilation of data from many different sources into the numerical models. Conversely, there are many parameters included in the data from the C3S 311a service that are required to correctly interpret the observations but that are not included in ODB. \\

To give the flexibility required, and to maintain compatibility with the ODB, the primary observations table within the CDM has been developed based on the ODB model, but with the metadata linked / nested through a series of auxiliary configuration tables. A schematic of this is shown in Figure 1 - a more complete schematic can be found at \url{https://github.com/glamod/common_data_model/blob/master/cdm_short.pdf}. The CDM consists of 7 primary tables:\\
\begin{itemize}
\item \textit{observations\_table} table (Table 2). This is the primary table, or data structure, containing the observations and information on the geospatial location of the observations (and station), date / time of the report, the observed parameter, source information; data licensing and usage permissions etc and links to additional metadata.
\item \textit{station\_configuration} table (Table 3). This table contains detailed information on the station reporting the data including: institute operating the station; the type of station; station / AWS model type; location; operating territory; reporting frequency etc.
\item \textit{source\_configuration} table (Table 5). This table contains detailed information on the source dataset, including: information on the product; whether any processing has been applied; the original data centre the data were sourced from; citation information; the data licence for the product; how to cite the data source etc.
\item \textit{profile\_configuration} table (Table 7). This table contains detailed metadata for atmospheric and oceanic profiles, including: profile type; type of launcher; direction of profile; balloon / XBT type etc.
\item \textit{sensor\_configuration} table (Table 9). This table contains detailed information on the sensor used to make a particular observation, including: calibration status; sampling strategy; observing method; sensor housing and ventilation; instrument model and serial number etc.
\item \textit{qc\_table} table (Table 11). This table contains detailed information on the quality control applied to each report and / or observation.
\item \textit{uncertainty\_table} table (Table 13). This table contains detailed information on the uncertainty budget for each observation.
\end{itemize}

\begin{figure}
\centering
\includegraphics[width=1\textwidth]{/Users/dyb/GitHub/common_data_model/png/cdm_schematic_simple.png}
\caption {Simplified schematic showing overview of common data model}
\end{figure}

\FloatBarrier

Whilst Figure 1 and the tables show the data model from a relational database perspective the same data model could be represented in XML. A simplified XML example of this is shown in Figure 2. For readability the majority of elements have been omitted, with a few example elements and nested data structures retained. In this example, the records from the configuration tables are nested within the entries for the respective records from the observations\_table. Similarly, the data model could be represented in NetCDF with elements common at the report level, and from the configuration tables, included in the NetCDF file as global or variable attributes as appropriate.\\

Within the following tables the following syntax has been used to indicate the data type for the different elements: \\
\begin{itemize}
\item numeric: \tabto{3 cm} Any numeric value (integer or floating point).
\item int: \tabto{3 cm} An integer value.
\item varchar: \tabto{3 cm} A variable length character string.
\item timestamp: \tabto{3 cm} A timestamp, e.g. "2017-07-01 00:00:0.0+00".
\item byte: \tabto{3 cm} A single byte of data used to store e.g. a bit flag array. 
\item {[]}:\tabto{3 cm} An array of the indicated type.
\item (fk)  \tabto{3 cm} The indicated value is also a foreign key linking to another table (e.g. decode table for encoded data).
\item (pk) \tabto{3 cm} The indicated elements marked as (pk) within a table form the unique ID for the record.
\end {itemize}

Mandatory elements are indicated by a 1 (or 1+) in the occurance column. Mandatory elements that are not available must be encoded but may be reported as missing (.e.g NA, NULL or format specific equivalent). Optional elements are indicated by 0+. Whilst arrays have been indicated for the elements containing multiple values this does not preclude other implementations. Where there are many optional elements for a given table these are parameterised and included in the appendix. For example, the \textit{station\_configuration} table has many optional elements, with valid optional elements, and their kind, listed in the \textit{station\_configuration\_fields} table. This, in turn, is linked to the \textit{station\_configuration\_codes} table. No method is specified for the inclusion of the additional elements as the inclusion is dependent on the implementation of the data model and format used (e.g. ASCII, NetCDF, XML, relational database). For example, as with the other configuration fields, the optional elements could be reported in the global attributes section of a NetCDF file. Alternatively, EAV based tables linked to the configuration tables could be used in a relational database setting. 

\begin{figure}
\begin{Framed}
\begin{lstlisting}[language=XML]
<observations_table>
    <report>
        <report_id type="integer"/>
        <region type="integer"/>
        <sub_region type="integer"/>
        <application_area type="array"></application_area>
        <observing_programme type="array"></observing_programme>
        <report_type type="integer"/>
        <station_name type="string"/>
        ...
        ...
        <station_configuration>
            <station_primary_id type="string"/>
            <station_primary_id_scheme type="integer"/>
            ...
            ...
            <field_numeric type="array"></field_numeric>
            <value_numeric type="array"></value_numeric>
             ...
        </station_configuration>
        ...
        ...
    </report>
    <report>
    ...
    </report>
</observations_table>
\end{lstlisting}
\end{Framed}
\caption{Truncated / simplified XML example of data model defined in Tables 3 - 7.}
\end{figure}
\FloatBarrier



%\subsection {Observations table}

\input{observations_table_wrapper}

%\subsection {Station configuration table}

%Entity-attribute value based table for station configuration (and others).
\input {station_configuration_wrapper}
\input {station_configuration_fields}
% \subsection {Profile configuration table}
\input {profile_configuration_wrapper}
\input {profile_configuration_fields}
% \subsection {Source configuration table}
\input {source_configuration_wrapper}
\input {source_configuration_fields}

% \subsection {Sensor configuration table}
\input {sensor_configuration_wrapper}
\input {sensor_configuration_fields}

\subsection {Quality control flags}
A single QC flag is provided in the observations table for the observed value. Additional flags can be provided using the qc\_table and by setting the advanced\_qc flag to true in the observations\_table.\\
\input {qc_table}

\subsection {Uncertainty budget}
A single standard uncertainty value is provided for each observed value in the observations table. Additional values can be provided using the uncertainty\_table and by setting the advanced\_uncertainty to true in the observations\_table.\\
\input {uncertainty_table}

% \section {Examples}

% \section {Mapping to WIGOS metadata standard}
% To do ...
% \section {Mapping to INSPIRE}
% To do ...
\section {Common Data Model governance and future development}
\begin{itemize}
\item Tables defining data model and decode tables stored in Git repository (\url{https://github.com/glamod/common_data_model/}).
\item Whilst service in development data model updated / revised annually (modified / new elements in Tables 3 - 7).
\item New entries to decode tables every 3 / 6 months (TBD).
\item Changes made by consensus across Lots and with ECMWF.
\item Mapping to WIGOS WMDS and INSPIRE / ISO 19139 (time permitting)
\item User guide to CDM (time permitting)
\end{itemize}

\section {Acknowledgements}
\begin{itemize}
\item Participants from Lot 1
\item Participants from Lot 2
\item Participants from Lot 3
\item External comments ...
\end{itemize}

\section {References}

\noindent WMO, 2015a: Manual On Codes (WMO-No 306), Volume I.2, Part B - Binary Codes, WMO, Geneva.\\
\noindent WMO, 2015b:  Manual on the WMO Integrated Global Observing System: Annex VIII to the Technical Regulations (WMO-No 1160), WMO, Geneva.

\section {Appendix}

\subsection {Code tables}

\input {adjustment}
\input {application_area}
\input {automation_status}
\input {calibration_status}
\input {communication_method}
\input {conversion_method}
\input {crs}
\input {data_policy_licence}
\input {duplicate_status}

\input {events_at_station}

\input {id_scheme}
\input {institute}
\input {instrument_exposure_quality}
\input {location_method}
\input {location_quality}
% \input {metadata_source}
\input {meaning_of_time_stamp}
\input {measuring_system_model}
\input {method_of_estimating_uncertainty}
\input {observed_variable}
\input {observation_code_table}
\input {observation_value_significance}
\input {observing_frequency}
\input {observing_method}
\input {observing_programme}
\input {platform_sub_type}
\input {platform_type}
\input {processing_level}
\input {product_level}
\input {product_status}
\input {profile_configuration_codes}
\input {quality_flag}
\input {region}
\input {report_processing_codes}
\input {report_processing_level}
\input {report_type}
\input {sampling_strategy}
\input {sea_level_datum}
\input {sensor_configuration_codes}
\input {source_configuration_codes}
\input {source_format}
\input {spatial_representativeness}
\input {station_configuration_codes}
\input {station_type}
\input {sub_region}
\input {time_quality}
\input {time_reference}
\input {traceability}
\input {units}
\input {update_frequency}
\input {z_coordinate_method}
\input {z_coordinate_type}

%\input {surface_type}
%\input {surface_type_scheme}
%\input {topography}
%\input {processing_code}


\end{document}


