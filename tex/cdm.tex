\documentclass[a4paper,11pt]{article}
\usepackage{pgfplotstable}
\usepackage{longtable}
\usepackage{varwidth}
\usepackage{array}
\usepackage{lscape}
\usepackage[top=4.5 cm,bottom=2.54cm, lmargin=2cm, rmargin=1.74cm, headheight=3.25cm]{geometry}
\usepackage{helvet}
\usepackage{tabto}
\usepackage{collcell}
\usepackage{seqsplit}
\usepackage{fancyhdr}
\usepackage{lastpage}
\usepackage{xcolor}
\usepackage{sectsty}
\usepackage{mdframed}
\usepackage{draftwatermark}
\usepackage{textpos}
\usepackage{placeins}
\usepackage{listings}
\usepackage{tikz}
\usepackage[hidelinks]{hyperref}
\usepackage{changepage}

\SetWatermarkText{Draft}

\definecolor{maroon}{RGB}{102,0,33}
\sectionfont{\color{maroon}}  % sets colour of section headings

\renewcommand{\familydefault}{\sfdefault}

% Set title etc
\title {Copernicus Climate Change Service - 311a Lot 2 \\ Defining a Common Data Model}
\author {David I. Berry \\ National Oceanography Centre, UK}
\date{\today}

% empty header style for tables later on
\pgfplotstableset{
empty header/.style={
           typeset cell/.append code={%
               \ifnum\pgfplotstablerow=-1 %
                   \pgfkeyssetvalue{/pgfplots/table/@cell content}{}%
               \fi
           }
       }
   }

% new column for tables to split long strings
\newcolumntype{n}[1]{  > {\collectcell\seqsplit} V{#1} < {\endcollectcell}    }

% no indent of new paragraphs
\setlength{\parindent}{0pt}

% framed text boxes
\newcounter{FramedDepth}
\setcounter{FramedDepth}{-1}
\mdfdefinestyle{Framed}{linecolor=black,linewidth=1pt,leftmargin=10pt,rightmargin=10pt,
                        innerleftmargin=10pt,innerrightmargin=10pt}
\newenvironment{Framed}{%
  \addtocounter{FramedDepth}{1}
  \ifcase\theFramedDepth\def\FrameColour{white!50}%
    \or\def\FrameColour{white!50}%
    \or\def\FrameColour{white!50}%
    \or\def\FrameColour{white!50}%
    \fi%
  \begin{mdframed}[style=Framed,backgroundcolor=\FrameColour]%
}{\end{mdframed}\addtocounter{FramedDepth}{-1}}

% 1.25 18.4, 1.7
% 0.65
% Copernicus logo on page 3 onwards needs to go at (18.4cm, 1.7cm from top left of page) size (0.9cm by 0.86 cm)

% headers and footers
\headheight 3.5 cm          
\headsep  0.5 cm

\lhead{\textcolor{maroon}{Copernicus Climate Change Service}\vskip 0.5 cm}
\rhead{\includegraphics{/Users/dyb/GitHub/common_data_model/png/c3s_logo_small.png} \vskip 0.3 cm}

\lfoot{C3S\_311a\_Lot2\_NUIM\_2017 \{ref\} }
\cfoot{}
\rfoot{Page \textbf{\thepage}  of \textbf{\pageref{LastPage}} }

\pagestyle{fancy}

\input {revision.tex}

\begin{document}\thispagestyle{empty}


% Cover sheet

% top banner
\begin{tikzpicture}[remember picture,overlay]
\draw ([yshift=-15.7mm]current page.north) node[inner sep=0] (a) {\includegraphics[width=\paperwidth]{/Users/dyb/GitHub/common_data_model/png/c3s_banner_top.png}};
\draw ([yshift=-25.7mm]current page.north) node[inner sep=0] (a) {\includegraphics[width=62.8mm]{/Users/dyb/GitHub/common_data_model/png/copernicus_logo_large.png}};
\node[shift={(0 mm, -10mm)}]  at (current page.north)   {
\tiny\color{white} ECMWF COPERNICUS REPORT \\
};
\end{tikzpicture}

% top maroon bar
\begin{tikzpicture}[remember picture,overlay]
\draw ([yshift=-53.3 mm]current page.north) node[inner sep=0] (a) {\includegraphics[width=\paperwidth]{/Users/dyb/GitHub/common_data_model/png/header_bar.png}};
\draw (17.75,-0.23) node {\includegraphics{/Users/dyb/GitHub/common_data_model/png/logo_thermometer.png}};
\node at (2.5,-0.35)   {
    \large{\textbf{\color{white} Copernicus Climate Change Service}}
};
%\draw[style=help lines] (-2.5,0) grid (30,10);
\end{tikzpicture}


% Document title: Common Data Model for in situ observations
% Contract / Lot title: C3S311a Lot 2: Global Land and Marine Observations database
% Issued by: NUIM / Peter Thorne
% Date: DD/MM/YYYY
% C3S_D311a_Lot2.2.1.1_201708_CDM_Definition_v1


\vskip 4cm
\begin{adjustwidth}{2.5cm}{}
\huge\textbf{Common Data Model for in situ observations}\\
\LARGE\textbf{\textcolor{maroon}{ C3S311a Lot 2: Global Land and Marine Observations Database } }\\
\vskip 5cm
\large{Issued by: XXXX / YYYY} \\

\large{Date: DD/MM/YYYY}\\

\large{Ref: C3S\_D311a\_Lot2.2.1.1\_201708\_CDM\_Definition\_v1}\\

\large{Official reference number service contract: 201x/C3S\_311a\_Lot2\_NUIM/SCx}\\
\end{adjustwidth}

%footer bar
\begin{tikzpicture}[remember picture,overlay]
\draw ([yshift=15. mm]current page.south) node[inner sep=0] (a) {\includegraphics[width=\paperwidth]{/Users/dyb/GitHub/common_data_model/png/footer_bar.png}};
\draw ([yshift=10.5 mm]current page.south) node[inner sep=0] (a) {\includegraphics{/Users/dyb/GitHub/common_data_model/png/copernicus_logo.png}};
\draw ([xshift=-30 mm, yshift=10.5 mm]current page.south east) node[inner sep=0] (a) {\includegraphics{/Users/dyb/GitHub/common_data_model/png/ECMWF_logo.png}};
\draw ([xshift=30 mm, yshift=10.5 mm]current page.south west) node[inner sep=0] (a) {\includegraphics{/Users/dyb/GitHub/common_data_model/png/ec_logo_small.png}};
\end{tikzpicture}
\newpage

\vspace*{\fill}
\begin{Framed}
This document has been produced in the context of the Copernicus Climate Change Service (C3S).\\
The activities leading to these results have been contracted by the European Centre for Medium-Range Weather Forecasts, operator of C3S on behalf of the European Union (Delegation Agreement signed on 11/11/2014). All information in this document is provided "as is" and no guarantee or warranty is given that the information is fit for any particular purpose.\\
The user thereof uses the information at its sole risk and liability. For the avoidance of all doubts, the European Commission
and the European Centre for Medium-Range Weather Forecasts has no liability in respect of this document, which is merely representing the authors view.
\end{Framed}

% title page
\newpage

\maketitle

\vskip 0.25in
\section*{Summary}
\hrule
\vskip 0.25in
This document defines the initial version of the Common Data Model (CDM) developed within the Copernicus Climate Change Service (C3S) Access to Global Land and Marine Observations Database (C3S 311a Lot 2) service. This has been developed in consultation across the C3S 311a (Collection and Processing of In Situ Observations) Lots and ECMWF.\\
\vskip 0.25in
Tab separated versions of the code tables defining the data model can be found at:\\ \\
\tabto{2cm} \url{https://github.com/glamod/common_data_model/tree/master/tables/tsv/}
\vskip 0.25in
\hrule
\vskip 1in
Revision number: \revision \\
Revision date: \revisiondate \\

\newpage
\tableofcontents
\newpage
\listoftables
\newpage


\section {Introduction}

\subsection {Purpose of this document}
This document defines the initial version of the Common Data Model (CDM)\footnote{As noted in the ITT: A common data model is different from a file format, which defines how information is encoded in a file. The purpose of a data model is to provide a well-defined data structure that can be used to represent data records from a variety of sources, in such a way that the information contained in those records can be unambiguously accessed using a common set of tools. Development of a common data model for observations involves specification of data attributes and their symbolic names, including, for example, identifiers for different instruments, observed parameters, geolocation and timing, etc. A governance structure is required to manage such specifications, ensure consistency with standards where they exist, and to ensure a controlled evolution of the data model.} developed within the Copernicus Climate Change Service (C3S) Access to Global Land and Marine Observations Database (C3S 311a Lot 2) service. This has been developed in consultation across the C3S 311a (Collection and Processing of In Situ Observations) Lots and ECMWF.

\subsection {Scope}
The defined common data model is intended for use with in situ land and marine observations. Instantaneous (or point) observations and temporal statistics (e.g. daily and monthly min / max temperatures, accumulation of precipitation etc.)  are supported through the use of a significance qualifier. Similarly, profile data is supported through reporting the z-coordinate alongside the observed value.\\

Whilst initially intended for use with observations of Essential Climate Variables (ECVs; e.g. GCOS, 2010) the data model is not restricted to the ECVs. Following the ECMWF Observations DataBase (ODB) type data model, the measurand (or observed parameter) is parameterized, with both the variable being reported and it's value specified in the data model.\\

Comprehensive metadata is supported through the use of configuration tables, recording information on:
\begin{itemize}
\item Source level metadata: e.g. original source of data, source data centre, citation information etc.
\item Station level metadata: e.g. location, operating institute, parameters reported etc.
\item Profile level metadata: Additional information for profile data, e.g. unwinder type, type of balloon or XBT etc.
\item Sensor level metadata: e.g. calibration history and status, sensor type / serial number etc.
\end{itemize}
Comprehensive quality control and uncertainty information can be recorded through the use of linked entity-attribute-value tables.

\subsection {Structure of this document}

Section 2 of this document provides background information on the data model and existing relevant data models and standards. Section 3 forms the core section of this document and defines the primary observations table and associated configuration, quality control and uncertainty budget tables. Recognising that the data model will change and evolve as the requirements of the users and the C3S Climate Data Store develop, Section 4 proposes a goverance model for the CDM and outlines future developments.

\section {Background and existing standards}
\subsection {Observational sources and requirements of the data model}

Across the C3S 311a service (Collection and Processing of In Situ Observations) access will be provided to observations from surface terrestrial and marine environments and upper air data in a common data model. The observations included in the service range from point observations made from moving platforms to daily and monthly statistics at fixed locations. The parameters reported include, inter alia: air temperature; humidity; wind speed; pressure; cloud cover information; present weather. The statistics include, inter alia: daily min, max and mean air temperature; accumulated precipitation over 3 or 24 hours; mean wind speed over the preceding 10 minutes. The full range of parameters and statistics to be reported will evolve as the service is developed. As new parameters are recovered from newly digitised sources and the reprocessed climate archives the list of parameters will need to expand.\\

Both surface level (terrestrial and marine) and upper air data will be initially included in the service. The surface level data include observations made at standard and non-standard heights. The upper air data will include multiple observations, starting at the surface and at increasing heights through the atmosphere, often as a function of pressure or geopotential height. As a result the data model needs to include the flexibility to record the height and the units used for reporting the height of measurement with every observation. Similarly, some reporting stations, and hence observations, will move in the horizontal plan, and the horizontal coordinates need to be reported with each observation. To avoid ambiguity, the CRS should be provided with each location reported.\\

The period covered by the service ranges from $\sim$1850 to present. Over this period there have been many changes to the instruments and practices used to record the various parameters. The choice of instruments and practices will influence the quality of the observations and a change in instrumentation, or location, may introduce inhomogeneities into the record. To mitigate this risk, comprehensive observational metadata, where it exists, is required. Similarly, information on adjustments and conversions applied to the data need to be recorded. The full range of observational practices and instruments used is not currently known and developed data model will need to be expandable to accommodate new metadata as required.\\

The observations to be included will be sourced from a variety of existing datasets, such as the International Comprehensive Ocean and Atmosphere Data Set (ICOADS; e.g. Freeman et al., 2017), and newly digitised sources. In defining the data model the provenance and lineage of the data sources need to be preserved. Similarly, usage rights and citation information for those data sources need to be preserved and provided to the users alongside the observational data.\\

In order to meet the above requirements a data model based on the ECMWF Observations DataBase (ODB) model has been developed, with the use of linked tables providing information on the observational and provenance metadata. The ODB type model allows for expansion to new parameters through the use of a parameterized observation list (see next section). The linked tables will define a core set of parameters under 4 different categories (station, source, profile and sensor), flexibility will be provided through the specification of optional elements and associated decode tables.\\

\subsection{ECMWF Observations DataBase (ODB)}

The data model developed and used in the ECMWF Observations DataBase (ODB) software allows the representation of environmental data from many sources, including in situ observations and weather reports, satellite data and model output. As noted in Hersbach et al. (2015), in the ODB implementation a distinction is made between weather reports and observations and this same distinction is made within the CDM and this document.  A weather report, such as a ship weather report or a radiosonde ascent, may contain multiple observations of one or more parameters. In the case of a ship weather report observations of the air temperature and humidity, sea level pressure, sea surface temperature, wind speed and direction are typically made and recorded in a single report. In the case of a radiosonde report observations of the temperature will be made at a range of levels from the surface to the burst point of the balloon. To enable flexibility and scalability with the ODB data model the different elements making up a weather report are split into header elements, recording information common across a weather report, and observational (or body) elements specific to a single observation.\\

In the original version of ODB, e.g. Saarinen (2004), these elements were split between a header table, containing the header elements, and a linked body table containing the observations or body elements. Within the body table the name of the parameter being observed, or its enumeration, is recorded in one column and the observed value within a second column.  Other columns, recording information such as QC results, are permissible. This data model allows the efficient expansion of the data model to new variables, without the need to change the underlying structure, by the addition of the new variable to the enumerated list defining the reportable variables. Within the latest version of ODB (ODB-2; e.g. Hersbach et al., 2015) the header and body tables have been combined into a single flat table, with the header rows repeated, to enable efficient archival within the ECMWF MARS system. A simplified schematic of the ODB-2 structure is shown in Table 1.\\

Within the CDM defined in this document we have opted for the original ODB type data model, with the reports split into header and observational records stored within separate tables. These are described fully within Section 3 of this document. When these tables are stored in a relational database, or similar structure, performing a join on the tables should result in ODB-2 compatible records.\\


\input{odb_example}

\subsection {BUFR and WIGOS Metadata Standard}
There has been a large body of work and significant effort previously invested in defining data models and parameterising the data and metadata for encoding the data into those data models.  Within the scope of the CDM and the C3S 311a service, the WMO Binary Universal Form for the Representation of meteorological data (BUFR) (WMO, 2015a) and the WMO Integrated Observing System Metadata Standard (WMDS) (WMO, 2015b) are key background material. \\

The BUFR format is a flexible and efficient table driven format for reporting weather observations on the WMO Global Telecommunications System (GTS) in binary. The tables defined as part of the BUFR format include many of the parameters that will be included in the CDM. For example, Common code table C6 (WMO 2015a) includes all the measurement units reportable in BUFR (and other WMO codes). Similarly, code tables are defined for reporting instrument types and methods, station types etc. Where possible, these code tables have been referenced and used in preference to defining new code tables.  Tables from Version 27 of Master Table 0 have been used in this document.\\

In recognition of the increasing importance of observational metadata the WMDS is currently under development and undergoing a phased implementation (WMO, 2015b). The WMDS forms an extension of the ISO19115 metadata standard, with additional mandatory elements describing both the station level and discovery metadata as well as specific information on the instrumentation used and processing steps. As part of the process simplified versions of BUFR and other tables have been included in the standard. As with BUFR these tables have been referenced, where appropriate, in preference to defining new code tables.

\section {Common Data Model}
As noted above, the common data model has been developed based on the original ODB data model, with meteorological reports split into header and observational records stored in separate tables. In support of these two primary tables 4 auxiliary tables have been defined to enable the comprehensive reporting of metadata at different levels:\\

\begin{itemize}
\item Source level metadata (\textit{source\_configuration} table). This level contains detailed information on the source dataset, including: information on the product; whether any processing has been applied; the original data centre the data were sourced from; citation information; the data licence for the product; how to cite the data source etc.
\item Station level metadata (\textit{station\_configuration} table). This level contains detailed information on the station reporting the data including: institute operating the station; the type of station; station / AWS model type; location; operating territory; reporting frequency etc.
\item Profile level metadata (\textit{profile\_configuration} table). This level contains detailed metadata for atmospheric and oceanic profiles, including: profile type; type of launcher; direction of profile; balloon / XBT type etc.
\item Instrument (or sensor) level metadata (\textit{sensor\_configuration} table). This level contains detailed information on the sensor used to make a particular observation, including: calibration status; sampling strategy; observing method; sensor housing and ventilation; instrument model and serial number etc.
\end{itemize}

These tables are defined in the following section and contain elements that are mandatory across all report types. Additional optional elements are provided through Entity-Attribute-Value based tables linked to the configuration tables. Two additional tables have been defined to include the reporting of comprehensive uncertainty estimates and quality control flags. A simplified schematic of the 12 tables forming the core of the CDM is shown in Figure 1 - a more complete schematic can be found at \url{https://github.com/glamod/common_data_model/blob/master/cdm_short.pdf}. \\

Within the tables in the following sections the following syntax has been:\\
\begin{itemize}
\item numeric: \tabto{3 cm} Any numeric value (integer or floating point).
\item int: \tabto{3 cm} An integer value.
\item varchar: \tabto{3 cm} A variable length character string.
\item timestamp: \tabto{3 cm} A timestamp, e.g. "2017-07-01 00:00:0.0+00".
\item byte: \tabto{3 cm} A single byte of data used to store e.g. a bit flag array. 
\item {[]}:\tabto{3 cm} An array of the indicated type.
\item (fk) \tabto{3 cm} The indicated value is also a foreign key linking to another table (e.g. decode table for encoded data).
\item (pk) \tabto{3 cm} The indicated elements marked as (pk) within a table form the unique ID for the record.
\end {itemize}

Mandatory elements are indicated by a 1 (or 1+) in the occurrence column. Mandatory elements that are not available must be included but may be encoded as missing (.e.g NA, NULL or format specific equivalent). Optional elements are indicated by 0+. Whilst arrays have been indicated for the elements containing multiple values this does not preclude other implementations. 

\begin{landscape}
\begin{figure}
\centering
\includegraphics[width=1\textwidth]{/Users/dyb/GitHub/common_data_model/png/cdm_schematic_simple.png}
\caption {Simplified schematic showing overview of common data model}
\end{figure}
\end{landscape}

\input{header_table_wrapper}

\input{observations_table_wrapper}

\input {station_configuration_wrapper}
\input {station_configuration_optional}
\input {station_configuration_fields}
\input {station_configuration_codes}

\input {profile_configuration_wrapper}
\input {profile_configuration_optional}
\input {profile_configuration_fields}
\input {profile_configuration_codes}

\input {source_configuration_wrapper}
\input {source_configuration_optional}
\input {source_configuration_fields}
\input {source_configuration_codes}

\input {sensor_configuration_wrapper}
\input {sensor_configuration_optional}
\input {sensor_configuration_fields}
\input {sensor_configuration_codes}

\subsection {Quality control flags}
A single QC flag is provided in the observations table for the observed value. Additional flags can be provided using the qc\_table and by setting the advanced\_qc flag to true in the observations\_table.\\
\input {qc_table}

\subsection {Uncertainty budget}
A single standard uncertainty value is provided for each observed value in the observations table. Additional values can be provided using the uncertainty\_table and by setting the advanced\_uncertainty to true in the observations\_table.\\
\input {uncertainty_table}

% \section {Examples}

% \section {Mapping to WIGOS metadata standard}
% To do ...
% \section {Mapping to INSPIRE}
% To do ...
\section {Common Data Model governance and future development}
\begin{itemize}
\item Tables defining data model and decode tables stored in Git repository (\url{https://github.com/glamod/common_data_model/}).
\item Whilst service in development data model updated / revised annually (modified / new elements in Tables 3 - 7).
\item New entries to decode tables every 3 / 6 months (TBD).
\item Changes made by consensus across Lots and with ECMWF.
\item Mapping to WIGOS WMDS and INSPIRE / ISO 19139 (time permitting)
\item User guide to CDM (time permitting)
\end{itemize}

\section {Acknowledgements}
\begin{itemize}
\item Participants from Lot 1
\item Participants from Lot 2
\item Participants from Lot 3
\item External comments ...
\end{itemize}

\section {References}

\hangindent=2em\hangafter=1 Freeman et al., 2017 ...

\hangindent=2em\hangafter=1 GCOS, 2010 ...

\hangindent=2em\hangafter=1 Hersbach, H., P. Poli and D. Dee, 2015: The observation feedback archive for ICOADS and ISPD datasets. ERA Report Series No. 18, ECMWF, Reading, UK, 31pp.

\hangindent=2em\hangafter=1 Saarinen, S., 2004: ODB User guide (draft 1st edition), ECMWF, Reading, UK, 289pp.

\hangindent=2em\hangafter=1 WMO, 2015a: Manual On Codes (WMO-No 306), Volume I.2, Part B - Binary Codes, WMO, Geneva.

\hangindent=2em\hangafter=1 WMO, 2015b:  Manual on the WMO Integrated Global Observing System: Annex VIII to the Technical Regulations (WMO-No 1160), WMO, Geneva.

\section {Appendix}
% \subsection {Observed variable}
\input {observed_variable_wrapper}
\begin{landscape}
\subsection {Other tables}
\input {adjustment}
\input {contact}
\input {conversion_method}
\input {organisation}
\end{landscape}
\subsection {Code tables}
\input {application_area}
\input {automation_status}
\input {calibration_status}
%\input {city}
\input {communication_method}
\input {crs}
\input {data_policy_licence}
\input {duplicate_status}
\input {events_at_station}
\input {id_scheme}
\input {instrument_exposure_quality}
\input {location_method}
\input {location_quality}
% \input {metadata_source}
\input {meaning_of_time_stamp}
\input {measuring_system_model}
\input {method_of_estimating_uncertainty}
\input {observation_code_table}
\input {observation_value_significance}
\input {observing_frequency}
\input {observing_method}
\input {observing_programme}
\input {platform_sub_type}
\input {platform_type}
\input {processing_code}
\input {processing_level}
\input {product_level}
\input {product_status}
\input {profile_type}
\input {quality_flag}
\input {region}
\input {report_processing_codes}
\input {report_processing_level}
\input {report_type}
\input {sampling_strategy}
\input {sea_level_datum}
\input {secondary_variable}
\input {source_format}
\input {spatial_representativeness}
\input {standard_time}
\input {station_type}
\input {sub_region}
\input {time_quality}
\input {time_reference}
\input {traceability}
\input {units}
\input {update_frequency}
\input {z_coordinate_method}
\input {z_coordinate_type}

%\input {surface_type}
%\input {surface_type_scheme}
%\input {topography}
%\input {processing_code}


\end{document}


